<div class="historical-charts-container">
  <div class="mb-4">
    <p-card>
      <div class="flex flex-wrap align-items-center gap-4">
        <div class="flex-1 min-w-16rem">
          <label class="block text-sm font-medium text-700 mb-2"
            >Vehículo</label
          >
          <p-dropdown
            [options]="filteredVehicles()"
            optionLabel="name"
            placeholder="Seleccionar vehículo"
            [(ngModel)]="selectedVehicle"
            (onChange)="onVehicleChange($event.value)"
            class="w-full"
          >
            <ng-template let-vehicle pTemplate="item">
              <div class="flex align-items-center gap-2">
                <div class="w-1rem h-1rem border-round bg-green-500"></div>
                <span>{{ vehicle.name }}</span>
                <span class="text-xs text-500">({{ vehicle.plate }})</span>
              </div>
            </ng-template>
          </p-dropdown>
        </div>

        <div class="flex-1 min-w-16rem">
          <label class="block text-sm font-medium text-700 mb-2"
            >Rango de Fechas</label
          >
          <p-calendar
            [(ngModel)]="dateRange"
            selectionMode="range"
            [readonlyInput]="true"
            placeholder="Seleccionar rango"
            (onSelect)="onDateRangeChange()"
            class="w-full"
          >
          </p-calendar>
        </div>

        <div class="flex gap-2">
          <p-button
            icon="pi pi-refresh"
            [loading]="isLoading()"
            (onClick)="onRefreshData()"
            severity="secondary"
            pTooltip="Actualizar datos"
          >
          </p-button>
        </div>
      </div>
    </p-card>
  </div>

  @if (selectedVehicle() && historicalData().length > 0) {
  <div class="grid mb-4">
    <div class="col-12 md:col-6 lg:col-3">
      <p-card class="text-center">
        <div class="p-4">
          <i class="pi pi-tachometer text-3xl text-blue-600 mb-2"></i>
          <h3 class="text-2xl font-bold text-900 m-0">
            {{ getAverageSpeed() | number : "1.0-1" }}
          </h3>
          <p class="text-sm text-600 m-0">Velocidad Promedio (km/h)</p>
        </div>
      </p-card>
    </div>

    <div class="col-12 md:col-6 lg:col-3">
      <p-card class="text-center">
        <div class="p-4">
          <i class="pi pi-car text-3xl text-green-600 mb-2"></i>
          <h3 class="text-2xl font-bold text-900 m-0">
            {{ getAverageFuelLevel() | number : "1.0-1" }}
          </h3>
          <p class="text-sm text-600 m-0">Combustible Promedio (%)</p>
        </div>
      </p-card>
    </div>

    <div class="col-12 md:col-6 lg:col-3">
      <p-card class="text-center">
        <div class="p-4">
          <i class="pi pi-map text-3xl text-yellow-600 mb-2"></i>
          <h3 class="text-2xl font-bold text-900 m-0">
            {{ getTotalDistance() | number : "1.0-0" }}
          </h3>
          <p class="text-sm text-600 m-0">Distancia Total (km)</p>
        </div>
      </p-card>
    </div>

    <div class="col-12 md:col-6 lg:col-3">
      <p-card class="text-center">
        <div class="p-4">
          <i class="pi pi-chart-line text-3xl text-purple-600 mb-2"></i>
          <h3 class="text-2xl font-bold text-900 m-0">
            {{ getAverageEfficiency() | number : "1.0-1" }}
          </h3>
          <p class="text-sm text-600 m-0">Eficiencia Promedio (km/L)</p>
        </div>
      </p-card>
    </div>
  </div>
  } @if (selectedVehicle()) {
  <p-tabView>
    <p-tabPanel header="Velocidad" leftIcon="pi pi-tachometer">
      <p-card>
        @if (speedChartData()) {
        <div class="chart-container">
          <p-chart
            type="line"
            [data]="speedChartData()!"
            [options]="chartOptions"
            height="400px"
          >
          </p-chart>
        </div>
        } @else {
        <div class="text-center py-8">
          <i class="pi pi-chart-line text-4xl text-400 mb-4"></i>
          <p class="text-600">No hay datos de velocidad disponibles</p>
        </div>
        }
      </p-card>
    </p-tabPanel>

    <p-tabPanel header="Combustible" leftIcon="pi pi-car">
      <p-card>
        @if (fuelChartData()) {
        <div class="chart-container">
          <p-chart
            type="line"
            [data]="fuelChartData()!"
            [options]="chartOptions"
            height="400px"
          >
          </p-chart>
        </div>
        } @else {
        <div class="text-center py-8">
          <i class="pi pi-chart-line text-4xl text-400 mb-4"></i>
          <p class="text-600">No hay datos de combustible disponibles</p>
        </div>
        }
      </p-card>
    </p-tabPanel>

    <p-tabPanel header="Distancia" leftIcon="pi pi-map">
      <p-card>
        @if (distanceChartData()) {
        <div class="chart-container">
          <p-chart
            type="line"
            [data]="distanceChartData()!"
            [options]="chartOptions"
            height="400px"
          >
          </p-chart>
        </div>
        } @else {
        <div class="text-center py-8">
          <i class="pi pi-chart-line text-4xl text-400 mb-4"></i>
          <p class="text-600">No hay datos de distancia disponibles</p>
        </div>
        }
      </p-card>
    </p-tabPanel>

    <p-tabPanel header="Eficiencia" leftIcon="pi pi-chart-line">
      <p-card>
        @if (efficiencyChartData()) {
        <div class="chart-container">
          <p-chart
            type="line"
            [data]="efficiencyChartData()!"
            [options]="chartOptions"
            height="400px"
          >
          </p-chart>
        </div>
        } @else {
        <div class="text-center py-8">
          <i class="pi pi-chart-line text-4xl text-400 mb-4"></i>
          <p class="text-600">No hay datos de eficiencia disponibles</p>
        </div>
        }
      </p-card>
    </p-tabPanel>
  </p-tabView>
  } @else {
  <p-card>
    <div class="text-center py-8">
      <i class="pi pi-chart-line text-6xl text-400 mb-4"></i>
      <h3 class="text-xl font-semibold text-600 mb-2">
        Selecciona un vehículo
      </h3>
      <p class="text-500">
        Elige un vehículo y un rango de fechas para ver los gráficos históricos
      </p>
    </div>
  </p-card>
  } @if (isLoading()) {
  <div
    class="fixed top-0 left-0 w-full h-full bg-black-alpha-50 flex align-items-center justify-content-center z-5"
  >
    <div class="surface-0 border-round p-4 flex align-items-center gap-3">
      <i class="pi pi-spin pi-spinner text-2xl text-blue-600"></i>
      <span class="text-600">Cargando datos históricos...</span>
    </div>
  </div>
  } @if (!isOnline()) {
  <div class="fixed bottom-0 right-0 z-4">
    <div
      class="bg-yellow-100 border-1 border-yellow-400 text-yellow-700 px-4 py-2 border-round shadow-2"
    >
      <div class="flex align-items-center gap-2">
        <i class="pi pi-wifi-slash text-sm"></i>
        <span class="text-sm font-medium">Mostrando datos en caché</span>
      </div>
    </div>
  </div>
  }
</div>
