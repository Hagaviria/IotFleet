<div class="user-management">
    <p-toast></p-toast>

    <!-- Header -->
    <div class="flex justify-content-between align-items-center mb-4">
        <h2 class="text-2xl font-bold text-gray-800">Gestión de Usuarios</h2>

        <!-- Botón de acción -->
        <div class="flex gap-2">
            <p-button label="Crear Usuario" icon="pi pi-user-plus" (onClick)="showCreateUserDialog()"
                [loading]="isLoading()">
            </p-button>
        </div>
    </div>

    <!-- Tabla de usuarios -->
    <p-card>
        <p-table [value]="filteredUsers()" [loading]="isLoading()" [paginator]="true" [rows]="10"
            [showCurrentPageReport]="true"
            currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} usuarios"
            [rowsPerPageOptions]="[10, 25, 50]" styleClass="p-datatable-sm">

            <ng-template pTemplate="header">
                <tr>
                    <th>Usuario</th>
                    <th>Email</th>
                    <th>Perfil</th>
                    <th>Estado</th>
                    <th>Fecha Creación</th>
                    <th>Acciones</th>
                </tr>
            </ng-template>

            <ng-template pTemplate="body" let-user>
                <tr>
                    <td>
                        <div class="flex align-items-center gap-3">
                            <div
                                class="w-3rem h-3rem border-round bg-primary-100 flex align-items-center justify-content-center">
                                <i class="pi pi-user text-primary-600"></i>
                            </div>
                            <div>
                                <div class="font-semibold">{{ user.nombre_completo }}</div>
                                <div class="text-sm text-500">{{ user.identificacion }}</div>
                            </div>
                        </div>
                    </td>
                    <td>
                        <div class="flex align-items-center gap-2">
                            <i class="pi pi-envelope text-500"></i>
                            <span>{{ user.correo }}</span>
                        </div>
                    </td>
                    <td>
                        <p-tag [value]="getProfileName(user.id_perfil)"
                            [severity]="user.id_perfil === 1 ? 'danger' : 'info'">
                        </p-tag>
                    </td>
                    <td>
                        <p-tag [value]="getStatusText(user.estado)" [severity]="getStatusColor(user.estado)">
                        </p-tag>
                    </td>
                    <td>
                        <div class="text-sm">
                            <div>{{ formatDate(user.creado_en) }}</div>
                        </div>
                    </td>
                    <td>
                        <div class="flex gap-2">
                            <p-button icon="pi pi-pencil" [text]="true" severity="info" pTooltip="Editar usuario"
                                (onClick)="showEditUserDialog(user)">
                            </p-button>

                            <p-button icon="pi pi-key" [text]="true" severity="warn" pTooltip="Cambiar contraseña"
                                (onClick)="showChangePasswordDialog(user)">
                            </p-button>

                            <p-button icon="pi pi-trash" [text]="true" severity="danger" pTooltip="Eliminar usuario"
                                (onClick)="onDeleteUser(user)">
                            </p-button>
                        </div>
                    </td>
                </tr>
            </ng-template>

            <ng-template pTemplate="emptymessage">
                <tr>
                    <td colspan="6" class="text-center py-4">
                        <div class="flex flex-column align-items-center gap-3">
                            <i class="pi pi-users text-4xl text-400"></i>
                            <span class="text-500">No hay usuarios registrados</span>
                        </div>
                    </td>
                </tr>
            </ng-template>
        </p-table>
    </p-card>

    <!-- Dialog para crear usuario -->
    <p-dialog header="Crear Usuario" [(visible)]="showCreateDialog" [modal]="true" [style]="{width: '600px'}"
        [closable]="true" [draggable]="false" [resizable]="false">

        <app-generic-form [formFields]="createUserFields" [loading]="isLoading()"
            (formSubmit)="onCreateUserSubmit($event)" (cancel)="cancelCreate()">
        </app-generic-form>
    </p-dialog>

    <!-- Dialog para editar usuario -->
    <p-dialog header="Editar Usuario" [(visible)]="showEditDialog" [modal]="true" [style]="{width: '600px'}"
        [closable]="true" [draggable]="false" [resizable]="false">

        <app-generic-form [formFields]="editUserFields" [loading]="isLoading()"
            (formSubmit)="onUpdateUserSubmit($event)" (cancel)="cancelEdit()">
        </app-generic-form>
    </p-dialog>

    <!-- Dialog para cambiar contraseña -->
    <p-dialog header="Cambiar Contraseña" [(visible)]="showPasswordDialog" [modal]="true" [style]="{width: '400px'}"
        [closable]="true" [draggable]="false" [resizable]="false">

        <form [formGroup]="passwordForm" (ngSubmit)="onChangePassword()">
            <div class="field">
                <label for="currentPassword" class="block text-sm font-medium mb-2">
                    Contraseña Actual <span class="text-red-500">*</span>
                </label>
                <p-password id="currentPassword" formControlName="currentPassword" placeholder="Contraseña actual"
                    [feedback]="false" [toggleMask]="true" class="w-full"
                    [class.ng-invalid]="passwordForm.get('currentPassword')?.invalid && passwordForm.get('currentPassword')?.touched">
                </p-password>
                @if (getFieldError(passwordForm, 'currentPassword')) {
                <small class="text-red-500">{{ getFieldError(passwordForm, 'currentPassword') }}</small>
                }
            </div>

            <div class="field">
                <label for="newPassword" class="block text-sm font-medium mb-2">
                    Nueva Contraseña <span class="text-red-500">*</span>
                </label>
                <p-password id="newPassword" formControlName="newPassword" placeholder="Nueva contraseña"
                    [feedback]="false" [toggleMask]="true" class="w-full"
                    [class.ng-invalid]="passwordForm.get('newPassword')?.invalid && passwordForm.get('newPassword')?.touched">
                </p-password>
                @if (getFieldError(passwordForm, 'newPassword')) {
                <small class="text-red-500">{{ getFieldError(passwordForm, 'newPassword') }}</small>
                }
            </div>

            <div class="field">
                <label for="confirmPassword" class="block text-sm font-medium mb-2">
                    Confirmar Contraseña <span class="text-red-500">*</span>
                </label>
                <p-password id="confirmPassword" formControlName="confirmPassword" placeholder="Confirmar contraseña"
                    [feedback]="false" [toggleMask]="true" class="w-full"
                    [class.ng-invalid]="passwordForm.get('confirmPassword')?.invalid && passwordForm.get('confirmPassword')?.touched">
                </p-password>
                @if (getFieldError(passwordForm, 'confirmPassword')) {
                <small class="text-red-500">{{ getFieldError(passwordForm, 'confirmPassword') }}</small>
                }
            </div>

            <div class="flex justify-content-end gap-2 mt-4">
                <p-button type="button" label="Cancelar" [text]="true" (onClick)="cancelPasswordChange()">
                </p-button>
                <p-button type="submit" label="Cambiar Contraseña" [disabled]="!passwordForm.valid"
                    [loading]="isLoading()">
                </p-button>
            </div>
        </form>
    </p-dialog>
</div>