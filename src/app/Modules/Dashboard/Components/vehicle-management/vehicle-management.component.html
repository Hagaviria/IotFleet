<div class="vehicle-management">
  <p-toast></p-toast>
  <p-confirmDialog></p-confirmDialog>

  <div class="flex justify-content-between align-items-center mb-4">
    <h2 class="text-2xl font-bold text-gray-800">Gestión de Vehículos</h2>

    @if (isAdmin()) {
    <p-button label="Crear Vehículo" icon="pi pi-plus" (onClick)="showCreateVehicleDialog()" [loading]="isLoading()">
    </p-button>
    }
  </div>

  <p-card>
    <p-table [value]="filteredVehicles()" [paginator]="true" [rows]="10" [loading]="isLoading()"
      [showCurrentPageReport]="true" currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} vehículos"
      [rowsPerPageOptions]="[5, 10, 25]" styleClass="p-datatable-sm">
      <ng-template pTemplate="header">
        <tr>
          <th>Placa</th>
          <th>Marca</th>
          <th>Modelo</th>
          <th>Capacidad (L)</th>
          <th>Consumo (L/100km)</th>
          <th>Estado</th>
          <th>Último Mantenimiento</th>
          @if (isAdmin()) {
          <th>Acciones</th>
          }
        </tr>
      </ng-template>

      <ng-template pTemplate="body" let-vehicle>
        <tr>
          <td>
            <span class="font-semibold text-blue-600">{{ vehicle.plate }}</span>
          </td>
          <td>{{ vehicle.brand || "N/A" }}</td>
          <td>{{ vehicle.model || "N/A" }}</td>
          <td>{{ vehicle.fuelCapacity || 0 }}</td>
          <td>{{ vehicle.fuelEfficiency | number : "1.1-1" }}</td>
          <td>
            <p-tag [value]="getStatusLabel(vehicle.status)" [severity]="getStatusSeverity(vehicle.status)">
            </p-tag>
          </td>
          <td>
            @if (vehicle.lastMaintenance) {
            {{ vehicle.lastMaintenance | date : "short" }}
            } @else {
            <span class="text-gray-400">Nunca</span>
            }
          </td>
          @if (isAdmin()) {
          <td>
            <div class="flex gap-2">
              <p-button icon="pi pi-pencil" [text]="true" severity="info" pTooltip="Editar vehículo"
                (onClick)="showEditVehicleDialog(vehicle)">
              </p-button>
              <p-button icon="pi pi-trash" [text]="true" severity="danger" pTooltip="Eliminar vehículo"
                (onClick)="deleteVehicle(vehicle)">
              </p-button>
            </div>
          </td>
          }
        </tr>
      </ng-template>

      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="8" class="text-center py-4">
            <div class="flex flex-column align-items-center gap-3">
              <i class="pi pi-car text-4xl text-gray-400"></i>
              <span class="text-gray-500">No hay vehículos registrados</span>
              @if (isAdmin()) {
              <p-button label="Crear Primer Vehículo" icon="pi pi-plus" (onClick)="showCreateVehicleDialog()">
              </p-button>
              }
            </div>
          </td>
        </tr>
      </ng-template>
    </p-table>
  </p-card>

  <!-- Dialog para crear vehículo -->
  <p-dialog header="Crear Nuevo Vehículo" [(visible)]="showCreateDialog" [modal]="true" [style]="{ width: '600px' }"
    [closable]="true" [draggable]="false" [resizable]="false">

    <app-generic-form [formFields]="createVehicleFields" [loading]="isLoading()"
      (formSubmit)="onCreateVehicleSubmit($event)" (cancel)="cancelCreate()">
    </app-generic-form>
  </p-dialog>

  <p-dialog header="Editar Vehículo" [(visible)]="showEditDialog" [modal]="true" [style]="{ width: '600px' }"
    [closable]="true" [draggable]="false" [resizable]="false">

    <div class="mb-4">
      <label class="block text-sm font-medium mb-2">Placa</label>
      <input pInputText [value]="selectedVehicle()?.plate" readonly class="w-full bg-gray-100" />
    </div>

    <app-generic-form [formFields]="editVehicleFields" [loading]="isLoading()"
      (formSubmit)="onUpdateVehicleSubmit($event)" (cancel)="cancelEdit()">
    </app-generic-form>
  </p-dialog>
</div>