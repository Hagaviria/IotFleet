<div class="sensor-data-management">
  <p-toast></p-toast>

  <div class="flex justify-content-between align-items-center mb-4">
    <div class="flex gap-2">
      <p-button label="Crear Datos de Sensor" icon="pi pi-plus" (onClick)="showCreateSensorDataDialog()"
        [loading]="isLoading()">
      </p-button>

      @if (!isSimulating()) {
      <p-button label="Iniciar Simulaci√≥n" icon="pi pi-play" severity="success" (onClick)="startSimulation()">
      </p-button>
      } @else {
      <p-button label="Detener Simulaci√≥n" icon="pi pi-stop" severity="danger" (onClick)="stopSimulation()">
      </p-button>
      }
    </div>
  </div>

  @if (isSimulating()) {
  <p-card class="mb-4">
    <div class="flex align-items-center gap-3">
      <i class="pi pi-spin pi-spinner text-blue-500"></i>
      <span class="text-blue-600 font-medium">Simulaci√≥n activa - Generando datos cada 5 segundos</span>
      <p-tag value="ACTIVO" severity="success"></p-tag>
    </div>
  </p-card>
  }

  <p-card class="mb-4">
    <div class="grid">
      <div class="col-12 md:col-6">
        <h4 class="font-medium text-gray-700 mb-2">Datos que se Env√≠an:</h4>
        <ul class="list-disc list-inside text-sm text-gray-600 space-y-1">
          <li><strong>üìç Ubicaci√≥n GPS:</strong> Latitud, Longitud, Altitud</li>
          <li><strong>‚õΩ Combustible:</strong> Nivel actual, Consumo</li>
          <li><strong>üå°Ô∏è Temperatura:</strong> Motor y Ambiente</li>
          <li><strong>üöó Velocidad:</strong> Velocidad actual</li>
        </ul>
      </div>
    </div>
  </p-card>

  <p-dialog header="Crear Datos de Sensor" [(visible)]="showCreateDialog" [modal]="true" [style]="{ width: '700px' }"
    [closable]="true" [draggable]="false" [resizable]="false">
    <form [formGroup]="sensorDataForm" (ngSubmit)="onCreateSensorData()">
      <div class="grid">
        <!-- Veh√≠culo -->
        <div class="col-12">
          <div class="field">
            <label for="vehicleId" class="block text-sm font-medium mb-2">
              Veh√≠culo <span class="text-red-500">*</span>
            </label>
            <p-dropdown id="vehicleId" formControlName="vehicleId" [options]="vehicles()" optionLabel="name"
              optionValue="id" placeholder="Seleccionar veh√≠culo" class="w-full" [class.ng-invalid]="
                sensorDataForm.get('vehicleId')?.invalid &&
                sensorDataForm.get('vehicleId')?.touched
              ">
            </p-dropdown>
            @if (getFieldError(sensorDataForm, 'vehicleId')) {
            <small class="text-red-500">{{
              getFieldError(sensorDataForm, "vehicleId")
              }}</small>
            }
          </div>
        </div>

        <!-- Ubicaci√≥n GPS -->
        <div class="col-12">
          <h4 class="font-medium text-gray-700 mb-3">üìç Ubicaci√≥n GPS</h4>
        </div>

        <div class="col-12 md:col-4">
          <div class="field">
            <label for="latitude" class="block text-sm font-medium mb-2">
              Latitud <span class="text-red-500">*</span>
            </label>
            <p-inputNumber id="latitude" formControlName="latitude" [min]="-90" [max]="90" [step]="0.000001"
              [minFractionDigits]="6" [maxFractionDigits]="6" placeholder="4.609710" class="w-full" [class.ng-invalid]="
                sensorDataForm.get('latitude')?.invalid &&
                sensorDataForm.get('latitude')?.touched
              ">
            </p-inputNumber>
            @if (getFieldError(sensorDataForm, 'latitude')) {
            <small class="text-red-500">{{
              getFieldError(sensorDataForm, "latitude")
              }}</small>
            }
          </div>
        </div>

        <div class="col-12 md:col-4">
          <div class="field">
            <label for="longitude" class="block text-sm font-medium mb-2">
              Longitud <span class="text-red-500">*</span>
            </label>
            <p-inputNumber id="longitude" formControlName="longitude" [min]="-180" [max]="180" [step]="0.000001"
              [minFractionDigits]="6" [maxFractionDigits]="6" placeholder="-74.081750" class="w-full"
              [class.ng-invalid]="
                sensorDataForm.get('longitude')?.invalid &&
                sensorDataForm.get('longitude')?.touched
              ">
            </p-inputNumber>
            @if (getFieldError(sensorDataForm, 'longitude')) {
            <small class="text-red-500">{{
              getFieldError(sensorDataForm, "longitude")
              }}</small>
            }
          </div>
        </div>

        <div class="col-12 md:col-4">
          <div class="field">
            <label for="altitude" class="block text-sm font-medium mb-2">
              Altitud (m) <span class="text-red-500">*</span>
            </label>
            <p-inputNumber id="altitude" formControlName="altitude" [min]="0" [max]="10000" [step]="0.1"
              [minFractionDigits]="1" [maxFractionDigits]="1" placeholder="2600.0" class="w-full" [class.ng-invalid]="
                sensorDataForm.get('altitude')?.invalid &&
                sensorDataForm.get('altitude')?.touched
              ">
            </p-inputNumber>
            @if (getFieldError(sensorDataForm, 'altitude')) {
            <small class="text-red-500">{{
              getFieldError(sensorDataForm, "altitude")
              }}</small>
            }
          </div>
        </div>

        <!-- Datos del Veh√≠culo -->
        <div class="col-12">
          <h4 class="font-medium text-gray-700 mb-3">üöó Datos del Veh√≠culo</h4>
        </div>

        <div class="col-12 md:col-6">
          <div class="field">
            <label for="speed" class="block text-sm font-medium mb-2">
              Velocidad (km/h) <span class="text-red-500">*</span>
            </label>
            <p-inputNumber id="speed" formControlName="speed" [min]="0" [max]="200" [step]="0.1" [minFractionDigits]="1"
              [maxFractionDigits]="1" placeholder="65.5" class="w-full" [class.ng-invalid]="
                sensorDataForm.get('speed')?.invalid &&
                sensorDataForm.get('speed')?.touched
              ">
            </p-inputNumber>
            @if (getFieldError(sensorDataForm, 'speed')) {
            <small class="text-red-500">{{
              getFieldError(sensorDataForm, "speed")
              }}</small>
            }
          </div>
        </div>

        <div class="col-12 md:col-6">
          <div class="field">
            <label for="fuelLevel" class="block text-sm font-medium mb-2">
              Nivel de Combustible (%) <span class="text-red-500">*</span>
            </label>
            <p-inputNumber id="fuelLevel" formControlName="fuelLevel" [min]="0" [max]="100" [step]="0.1"
              [minFractionDigits]="1" [maxFractionDigits]="1" placeholder="75.0" class="w-full" [class.ng-invalid]="
                sensorDataForm.get('fuelLevel')?.invalid &&
                sensorDataForm.get('fuelLevel')?.touched
              ">
            </p-inputNumber>
            @if (getFieldError(sensorDataForm, 'fuelLevel')) {
            <small class="text-red-500">{{
              getFieldError(sensorDataForm, "fuelLevel")
              }}</small>
            }
          </div>
        </div>

        <div class="col-12 md:col-6">
          <div class="field">
            <label for="fuelConsumption" class="block text-sm font-medium mb-2">
              Consumo (L/100km) <span class="text-red-500">*</span>
            </label>
            <p-inputNumber id="fuelConsumption" formControlName="fuelConsumption" [min]="0.1" [max]="50" [step]="0.1"
              [minFractionDigits]="1" [maxFractionDigits]="1" placeholder="8.2" class="w-full" [class.ng-invalid]="
                sensorDataForm.get('fuelConsumption')?.invalid &&
                sensorDataForm.get('fuelConsumption')?.touched
              ">
            </p-inputNumber>
            @if (getFieldError(sensorDataForm, 'fuelConsumption')) {
            <small class="text-red-500">{{
              getFieldError(sensorDataForm, "fuelConsumption")
              }}</small>
            }
          </div>
        </div>

        <div class="col-12 md:col-6">
          <div class="field">
            <label for="engineTemperature" class="block text-sm font-medium mb-2">
              Temperatura Motor (¬∞C) <span class="text-red-500">*</span>
            </label>
            <p-inputNumber id="engineTemperature" formControlName="engineTemperature" [min]="-40" [max]="150"
              [step]="0.1" [minFractionDigits]="1" [maxFractionDigits]="1" placeholder="85.0" class="w-full"
              [class.ng-invalid]="
                sensorDataForm.get('engineTemperature')?.invalid &&
                sensorDataForm.get('engineTemperature')?.touched
              ">
            </p-inputNumber>
            @if (getFieldError(sensorDataForm, 'engineTemperature')) {
            <small class="text-red-500">{{
              getFieldError(sensorDataForm, "engineTemperature")
              }}</small>
            }
          </div>
        </div>

        <div class="col-12">
          <div class="field">
            <label for="ambientTemperature" class="block text-sm font-medium mb-2">
              Temperatura Ambiente (¬∞C) <span class="text-red-500">*</span>
            </label>
            <p-inputNumber id="ambientTemperature" formControlName="ambientTemperature" [min]="-40" [max]="60"
              [step]="0.1" [minFractionDigits]="1" [maxFractionDigits]="1" placeholder="22.0" class="w-full"
              [class.ng-invalid]="
                sensorDataForm.get('ambientTemperature')?.invalid &&
                sensorDataForm.get('ambientTemperature')?.touched
              ">
            </p-inputNumber>
            @if (getFieldError(sensorDataForm, 'ambientTemperature')) {
            <small class="text-red-500">{{
              getFieldError(sensorDataForm, "ambientTemperature")
              }}</small>
            }
          </div>
        </div>
      </div>

      <div class="flex justify-content-end gap-2 mt-4">
        <p-button type="button" label="Cancelar" [text]="true" (onClick)="cancelCreate()">
        </p-button>
        <p-button type="submit" label="Enviar Datos" [disabled]="!sensorDataForm.valid" [loading]="isLoading()">
        </p-button>
      </div>
    </form>
  </p-dialog>
</div>