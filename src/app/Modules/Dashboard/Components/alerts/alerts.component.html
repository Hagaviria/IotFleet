<div class="alerts-container">
  <!-- Header with Statistics -->
  <div class="mb-4">
    <div class="grid">
      <div class="col-12 md:col-4">
        <p-card class="text-center">
          <div class="p-4">
            <i class="pi pi-bell text-3xl text-blue-600 mb-2"></i>
            <h3 class="text-2xl font-bold text-900 m-0">{{ unreadCount() }}</h3>
            <p class="text-sm text-600 m-0">Alertas sin leer</p>
          </div>
        </p-card>
      </div>

      <div class="col-12 md:col-4">
        <p-card class="text-center">
          <div class="p-4">
            <i class="pi pi-exclamation-triangle text-3xl text-red-600 mb-2"></i>
            <h3 class="text-2xl font-bold text-900 m-0">
              {{ criticalCount() }}
            </h3>
            <p class="text-sm text-600 m-0">Alertas críticas</p>
          </div>
        </p-card>
      </div>

      <div class="col-12 md:col-4">
        <p-card class="text-center">
          <div class="p-4">
            <i class="pi pi-chart-line text-3xl text-purple-600 mb-2"></i>
            <h3 class="text-2xl font-bold text-900 m-0">
              {{ predictiveCount() }}
            </h3>
            <p class="text-sm text-600 m-0">Alertas predictivas</p>
          </div>
        </p-card>
      </div>
    </div>
  </div>

  <!-- Filters and Actions -->
  <p-card class="mb-4">
    <div class="flex flex-wrap align-items-center gap-4">
      <!-- Severity Filter -->
      <div class="flex-1 min-w-12rem">
        <label class="block text-sm font-medium text-700 mb-2">Severidad</label>
        <p-dropdown [options]="severityOptions" optionLabel="label" optionValue="value" [(ngModel)]="selectedSeverity"
          (onChange)="onSeverityChange()" class="w-full">
        </p-dropdown>
      </div>

      <!-- Type Filter -->
      <div class="flex-1 min-w-12rem">
        <label class="block text-sm font-medium text-700 mb-2">Tipo</label>
        <p-dropdown [options]="typeOptions" optionLabel="label" optionValue="value" [(ngModel)]="selectedType"
          (onChange)="onTypeChange()" class="w-full">
        </p-dropdown>
      </div>

      <!-- Vehicle Filter -->
      <div class="flex-1 min-w-12rem">
        <label class="block text-sm font-medium text-700 mb-2">Vehículo</label>
        <p-dropdown [options]="vehicleOptions()" optionLabel="label" optionValue="value" [(ngModel)]="selectedVehicle"
          (onChange)="onVehicleChange()" class="w-full">
        </p-dropdown>
      </div>

      <!-- Action Buttons -->
      <div class="flex gap-2">
        @if (isAdmin()) {
        <p-button label="Generar Predictivas" icon="pi pi-chart-line" [loading]="isLoading()"
          (onClick)="onGeneratePredictiveAlerts()" severity="info" pTooltip="Generar alertas predictivas">
        </p-button>
        }

        <p-button label="Marcar Todas" icon="pi pi-check" (onClick)="onMarkAllAsRead()" severity="secondary"
          pTooltip="Marcar todas como leídas">
        </p-button>
      </div>
    </div>
  </p-card>

  <!-- Alerts Table -->
  <p-card>
    @if (filteredAlerts().length > 0) {
    <p-table [value]="filteredAlerts() || []" [paginator]="true" [rows]="10" [showCurrentPageReport]="true"
      currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} alertas"
      [rowsPerPageOptions]="[5, 10, 25]" styleClass="p-datatable-sm">
      <ng-template pTemplate="header">
        <tr>
          <th style="width: 3rem"></th>
          <th>Alerta</th>
          <th>Vehículo</th>
          <th>Severidad</th>
          <th>Tipo</th>
          <th>Fecha</th>
          <th>Acciones</th>
        </tr>
      </ng-template>

      <ng-template pTemplate="body" let-alert>
        <tr [class.bg-blue-50]="!alert.isRead" [class.font-semibold]="!alert.isRead">
          <td>
            @if (!alert.isRead) {
            <div class="w-1rem h-1rem bg-blue-600 border-round"></div>
            }
          </td>
          <td>
            <div class="flex align-items-start gap-3">
              <i [class]="getAlertIcon(alert.type)" [class]="alert.isPredictive ? 'text-purple-600' : 'text-600'"
                class="text-lg mt-1"></i>
              <div>
                <div class="font-medium text-900">{{ alert.title }}</div>
                <div class="text-sm text-600 mt-1">{{ alert.message }}</div>
                @if (alert.isPredictive && alert.predictedDate) {
                <div class="text-xs text-purple-600 mt-1">
                  <i class="pi pi-clock mr-1"></i>
                  Predicción: {{ alert.predictedDate | date : "short" }}
                </div>
                }
              </div>
            </div>
          </td>
          <td>
            <div class="text-sm">
              <div class="font-medium">
                {{ getVehicleName(alert.vehicleId) }}
              </div>
            </div>
          </td>
          <td>
            <p-tag [value]="alert.severity.toUpperCase()" [severity]="getAlertSeverityColor(alert.severity)"
              [icon]="getAlertSeverityIcon(alert.severity)">
            </p-tag>
          </td>
          <td>
            <div class="flex align-items-center gap-2">
              <span class="text-sm font-medium">{{
                alert.type.toUpperCase()
                }}</span>
              @if (alert.isPredictive) {
              <p-tag value="PREDICTIVA" severity="info" icon="pi pi-chart-line"></p-tag>
              }
            </div>
            @if (alert.confidence) {
            <div class="text-xs text-500 mt-1">
              Confianza: {{ getConfidenceText(alert.confidence) }}
            </div>
            }
          </td>
          <td>
            <div class="text-sm">
              <div class="font-medium">
                {{ getFormattedDate(alert.timestamp) }}
              </div>
              <div class="text-500">{{ getTimeAgo(alert.timestamp) }}</div>
            </div>
          </td>
          <td>
            <div class="flex gap-2">
              @if (!alert.isRead) {
              <p-button icon="pi pi-check" size="small" severity="success" (onClick)="onMarkAsRead(alert)"
                pTooltip="Marcar como leída">
              </p-button>
              }

              <p-button icon="pi pi-trash" size="small" severity="danger" (onClick)="onDeleteAlert(alert)"
                pTooltip="Eliminar">
              </p-button>
            </div>
          </td>
        </tr>
      </ng-template>

      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="7" class="text-center py-8">
            <i class="pi pi-bell-slash text-4xl text-400 mb-4"></i>
            <p class="text-600">
              No hay alertas que coincidan con los filtros seleccionados
            </p>
          </td>
        </tr>
      </ng-template>
    </p-table>
    } @else {
    <div class="text-center py-8">
      <i class="pi pi-bell-slash text-6xl text-400 mb-4"></i>
      <h3 class="text-xl font-semibold text-600 mb-2">No hay alertas</h3>
      <p class="text-500">No se encontraron alertas con los filtros actuales</p>
    </div>
    }
  </p-card>

  <!-- Predictive Alerts Dialog -->
  <p-dialog header="Alertas Predictivas" [modal]="true" [visible]="showPredictiveDialog()" [style]="{ width: '600px' }"
    (onHide)="onHidePredictiveDialog()">
    <div class="gap-4">
      <div class="bg-blue-50 p-4 border-round">
        <h4 class="font-semibold text-blue-900 mb-2">
          ¿Qué son las alertas predictivas?
        </h4>
        <p class="text-blue-800 text-sm m-0">
          Las alertas predictivas utilizan análisis de datos históricos y
          patrones de comportamiento para predecir posibles problemas antes de
          que ocurran, permitiendo un mantenimiento proactivo y una mejor
          gestión de la flota.
        </p>
      </div>

      <div class="gap-3">
        <div class="flex align-items-center gap-3 p-3 surface-100 border-round">
          <i class="pi pi-wrench text-2xl text-yellow-600"></i>
          <div>
            <h5 class="font-medium m-0">Mantenimiento Predictivo</h5>
            <p class="text-sm text-600 m-0">
              Predice cuándo un vehículo necesitará mantenimiento
            </p>
          </div>
        </div>

        <div class="flex align-items-center gap-3 p-3 surface-100 border-round">
          <i class="pi pi-car text-2xl text-red-600"></i>
          <div>
            <h5 class="font-medium m-0">Nivel de Combustible</h5>
            <p class="text-sm text-600 m-0">
              Predice cuándo un vehículo se quedará sin combustible
            </p>
          </div>
        </div>

        <div class="flex align-items-center gap-3 p-3 surface-100 border-round">
          <i class="pi pi-tachometer text-2xl text-orange-600"></i>
          <div>
            <h5 class="font-medium m-0">Violaciones de Velocidad</h5>
            <p class="text-sm text-600 m-0">
              Predice posibles violaciones de velocidad en rutas específicas
            </p>
          </div>
        </div>
      </div>

      @if (!isOnline()) {
      <div class="bg-yellow-50 p-3 border-round">
        <p class="text-yellow-800 text-sm m-0">
          <i class="pi pi-wifi-slash mr-2"></i>
          Las alertas predictivas requieren conexión a internet para funcionar
          correctamente.
        </p>
      </div>
      }
    </div>

    <ng-template pTemplate="footer">
      <div class="flex justify-content-end gap-2">
        <p-button label="Cerrar" severity="secondary" (onClick)="onHidePredictiveDialog()">
        </p-button>
        @if (isAdmin() && isOnline()) {
        <p-button label="Generar Alertas" icon="pi pi-chart-line" [loading]="isLoading()"
          (onClick)="onGeneratePredictiveAlerts()">
        </p-button>
        }
      </div>
    </ng-template>
  </p-dialog>
  <p-confirmDialog></p-confirmDialog>
</div>